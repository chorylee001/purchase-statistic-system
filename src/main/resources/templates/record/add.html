<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<body class="hold-transition skin-blue sidebar-mini">
<section class="content-header">

    <h1>
        话术管理
        <small>话术添加</small>
        <button type="submit" class="btn btn-primary upload-audio top-button" data-toggle="modal"
                data-target="#upload-modal">上传话术音频
        </button>
    </h1>
</section>
<!-- Main content -->
<section class="content">
    <div class="box box-primary">
        <form class="form-horizontal main-from" id="mainForm" action="/record/o_save" method="post">
            <div class="box-body">
                <div class="form-group">
                    <label class="col-sm-2 control-label">话术名称<label class="warn-star">*</label></label>
                    <div class="col-sm-8">
                        <input type="text" name="documentDesc" class="form-control" placeholder="请添加小于20个汉字的话术名称" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">所属企业<label class="warn-star">*</label></label>
                    <div class="col-sm-8">
                        <input type="hidden" name="companyId">
                        <select class="form-control select-control" style="width: 100%;" id="sel_company" name="companySel">
                            <!--<option selected="selected">量化派</option>-->
                            <div th:each="company : ${companys}">

                                <option name="company" th:text="${company.companyName}" th:value="${company.id}"></option>
                            </div>
                        </select>
                    </div>
                </div>
                <!--<div class="form-group">
                  <label for="prologue">开场白<label class="warn-star">*</label></label>
                  <input type="file" id="prologue">
                  <p class="help-block">请上传wav格式音频开场白.</p>
                </div>-->
                <div class="form-group">
                    <label for="template" class="col-sm-2 control-label">话术文档<label class="warn-star">*</label></label>
                    <div class="col-sm-8">
                        <input type="file" id="template" name="template" onchange="checkExcelFile(this.files[0])" required>
                        <!--<p class="help-block">请上传excel格式话术文档.</p>-->
                    </div>
                </div>
                <!--<div class="form-group">
                    <label class="col-sm-2 control-label">开场白话术ID<label class="warn-star">*</label></label>
                    <div class="col-sm-8">
                        <input type="text" name="documentId" class="form-control" placeholder="">
                    </div>
                </div>-->
                <div class="form-group">
                    <label class="col-sm-2 control-label">是否使用合成<label class="warn-star">*</label></label>
                    <div class="col-sm-8 radio-group">
                        <label>
                            <input type="radio" name="useCompose" class="minimal-red" value="0" checked>&nbsp;&nbsp;否
                        </label>
                        <label>
                            <input type="radio" name="useCompose" class="minimal" value="1">&nbsp;&nbsp;是
                        </label>
                    </div>

                </div>
            </div>
            <div class="box-footer box-adjacent">
                <input type="button" class="btn btn-default roolback" value="返&nbsp;&nbsp;&nbsp;&nbsp;回"></input>
                <input type="button" class="btn btn-primary submit btn-adjacent" value="提&nbsp;&nbsp;&nbsp;&nbsp;交"></input>
            </div>
        </form>

        <!--文件批量上传模态框-->
        <div class="modal fade" id="upload-modal" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog"> <!--modal-lg-->
                <form class="modal-content audio-form" id="audio_form">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">上传话术音频</h4>
                    </div>
                    <div class="modal-body limit-body">
                        <label for="audio_file" class="fileupload-group">
                            <input type="button" class="append-button btn btn-block btn-primary" value="选择文件"></input>
                            <label class="path-label">请上传wav格式文件.</label>
                            <input type="file" class="file" id="audio_file" name="audio_file" multiple>
                            <input type="button" class="btn-upload btn-success" value="上传">
                        </label>
                        <div class="box-body process-body">
                            <table class="table table-bordered">
                                <tr class="header-tr">
                                    <th>文件名</th>
                                    <th>服务器地址</th>
                                    <th>状态</th>
                                </tr>
                            </table>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default pull-left" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary ensure" data-dismiss="modal">确定</button>
                    </div>
                </form>
            </div>
        </div>

    </div>
</section>
<script th:inline="javascript">
    $(function () {

        $('.select-control').select2();
        $('input[type="checkbox"].minimal, input[type="radio"].minimal').iCheck({
            checkboxClass: 'icheckbox_minimal-blue',
            radioClass: 'iradio_minimal-blue'
        })
        $('input[type="checkbox"].minimal-red, input[type="radio"].minimal-red').iCheck({
            checkboxClass: 'icheckbox_minimal-red',
            radioClass: 'iradio_minimal-red'
        })
        $(".upload-audio").on('click', function (e) {

        })
        $("#audio_file").on("click", function () {

            $(".header-tr").siblings("tr").remove();
            $(this).value = '';
            $(".fileupload-group .path-label").html("请上传wav格式文件.");
        })
        /**
         * 文件选中后触发
         */
        $("#audio_file").on('change', function (e) {

            for (var i = 0; i < this.files.length; i++) {
                if (!checkWAVFile(this.files[i])) {
                    $(".header-tr").siblings("tr").remove();
                    return;
                }
                if (i == 0) {
                    $(".process-body").css("display", "block");
                }
                var line_process = "<tr>" +
                    "<td>" + this.files[i].name + "</td>" +
                    "<td class='server-path'></td>" +
                    "<td></td>" +
                    "</tr>";
                $(".process-body table").append(line_process);
            }
            $(".fileupload-group .path-label").html(document.getElementById("audio_file").files.length + "个文件");
        })
        /**
         * 文件上传
         */
        /*$(".btn-upload").click(function (e) {

            var formData = new FormData($("#audio_form")[0]);
            var dataBody = $(".process-body table tr");
            $.ajax({
                type: "POST",
                url: "file/upload",
                dataType: "JSON",
                crossDomain: true,
                data: formData,
                async: false,
                cache: false,
                contentType: false,
                processData: false,
                success:function(result){

                    console.log(result.data);
                    console.log(result);
                    var value;
                    for(key in result.data){

                        value = result.data[key];

                    }
                },error:function (xhr,textStatus) {
                    bootAlert("文件上传失败,请稍后重试!");
                }
            });
        });*/
        /**
         * 单个文件上传
         */
        $(".btn-upload").click(function (e) {

            setModalStyle(callback_upload())

        });

        /**
         * 清空模态框
         */
        $('#upload-modal').on('hide.bs.modal', function () {

            $(".process-body").css("display", "none");
            $(".header-tr").siblings("tr").remove();
            //清空文件
            document.getElementById("audio_file").value = '';
            $("#upload-modal .modal-dialog").removeClass("modal-lg");
        })

        /**
         * 追加文件按钮
         */
        $(".append-button").on('click', function (e) {
            $("#audio_file").click();

            /*var ic = "<label for='file_input'>" +
                        "<input type='button' class='btn-file-input' " +"value='选择'>" +
                        "<span id='text'>请选择wav格式音频文件.</span>" +
                        "<input type='file' id='file_input'>" +
                    "</label>";
            $(".path-label").html(ic);*/
        })
        /**
         *  模态框文件提交
         */
        $("#upload-modal submit").click(function (e) {
            var formData = new FormData();
            var file = document.getElementById("audio_file");

            each; //--------

            formData.append("file", file.files[0]);
            fileUpload(uploadSuccess);
            $.ajax({
                data: formData,
                contentType: false,
                processData: false//避免参数序列化
            })
        })
        validateForm();
        /**
         * 保存
         */
        $("#mainForm .submit").on('click',function (e) {

            $('#mainForm').bootstrapValidator('validate');
            if(!$('#mainForm').data('bootstrapValidator').isValid()){
                return;
            }
            if ($('input').hasClass('error') || $(this).hasClass('error')) {
                return;
            } else {
                $(".roolback").attr('disabled',true);
                $(this).attr('disabled',true);
                $("input[name='companyId']").val($("#sel_company").find("option:selected").val());
                LoadAjaxFileForm(document.getElementById("mainForm"));
            }
        });

        /**
         * 返回
         */
        $("#mainForm .roolback").on('click',function (e) {

            LoadAjaxContent("/record/index");
        });
    })
    function setModalStyle(callback){

        //set waitting
        $(".process-body table").find('tr').each(function () {
            $(this).find("td:last-child").html("<span class='badge bg-gray'><i class='fa fa-refresh fa-spin'></i></span>");
        });

        $("#upload-modal .modal-dialog").addClass("modal-lg");
        callback();
    }
    function callback_upload(){
        var files = document.getElementById("audio_file").files;
        var dataBody = $(".process-body table");
        var responseData, serverPath;
        var url = "file/singleUpload";
        for (var i = 0; i < files.length; i++) {

            responseData = singleUpload("audio_file", files[i], url);
            if (responseData.status == 1) {
                for (key in responseData.data) {
                    serverPath = responseData.data[key];
                    dataBody.find('tr').each(function (e) {
                        if ($(this).find("td:first-child").text() == key) {
                            $(this).find("td.server-path").html(serverPath);
                            $(this).find("td:last-child").html("<span class='badge bg-green'><i class='fa fa-check'></i></span>");
                        }
                    })
                }
            } else {
                bootAlert("上传失败,请重试.")
            }
        }
    }
    function validateForm(){
        $('#mainForm').bootstrapValidator({
            message: '您输入的字符无效',
            feedbackIcons: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',
                validating: 'glyphicon glyphicon-refresh'
            },
            fields: {
                documentDesc: {
                    message: '话术名称无效.',
                    validators: {
                        notEmpty: {
                            message: '请输入话术名称.'
                        },
                        stringLength: {
                            min: 2,
                            max: 30,
                            message: '话术名称最少2个汉字，最多30个汉字.'
                        }
                        /*regexp: {
                            regexp: /^[a-zA-Z0-9_\.]+$/,
                            message: '话术名称只能由字母、数字、点和下划线组成'
                        },*/
                    }
                },
                template: {
                    validators: {
                        notEmpty: {
                            message: '请选择话术文件.'
                        }
                    }
                }
            }
        });
        // $("#mainForm")
    }
    uploadSuccess = function () {

    }
</script>
</body>
</html>
